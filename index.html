<script>
document.addEventListener('DOMContentLoaded', () => {
  // Helpers d'element
  const $ = (id) => document.getElementById(id);

  // Refs DOM
  const el = {
    fur: $('fur'),
    ciclo: $('ciclo'),
    ecoDate: $('ecoDate'),
    gaW: $('gaW'),
    gaD: $('gaD'),
    kpp: $('kpp'),
    kven: $('kven'),
    ksem: $('ksem'),
    khitos: $('khitos'),
    kpis: $('kpis'),
    out: $('out')
  };

  // Utils de dates
  const fmt = (d) => d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };
  const diffDays = (a, b) => Math.round((a - b) / (1000*60*60*24));

  function resetOut(){
    el.kpis.style.display = 'none';
    el.out.textContent = 'Introduce los datos y pulsa “Calcular FPP”.';
    window.__res = null;
  }

  function paint(dpp, base){
    const hoy = new Date();
    const diasTot = 280;
    const trans = diasTot - diffDays(dpp, hoy);
    const s = Math.max(0, Math.floor(trans/7));
    const d = Math.max(0, trans - s*7);

    const ven38 = addDays(base, 38*7);
    const ven42 = addDays(base, 42*7);
    const t2 = addDays(base, 13*7 - 1); // ~fi S13
    const t3 = addDays(base, 28*7);     // ~inici S28

    el.kpp.textContent   = fmt(dpp);
    el.kven.textContent  = `${fmt(ven38)} → ${fmt(ven42)}`;
    el.ksem.textContent  = `${s} semanas ${d} días`;
    el.khitos.textContent= `Trim2: ${fmt(t2)} · Trim3: ${fmt(t3)}`;

    el.kpis.style.display = '';
    el.out.textContent = 'Resultado listo ✅';
    window.__res = { dpp: fmt(dpp), v38: fmt(ven38), v42: fmt(ven42), semanas: s, d: d };
  }

  function calcFUR(){
    const v = el.fur.value;
    const ciclo = parseInt(el.ciclo.value || '28', 10);
    if (!v || isNaN(ciclo)){ alert('Completa FUR y duración de ciclo'); return; }
    const furDate = new Date(v);
    const dpp = addDays(furDate, 280 + (ciclo - 28)); // ajust aproximat per cicle
    paint(dpp, addDays(dpp, -280));
  }

  function clearFUR(){
    el.fur.value = '';
    el.ciclo.value = 28;
    resetOut();
  }

  function calcECO(){
    const ecoV = el.ecoDate.value;
    const w = parseInt(el.gaW.value || '0', 10);
    const d = parseInt(el.gaD.value || '0', 10);
    if(!ecoV || isNaN(w) || isNaN(d)){ alert('Completa fecha de ecografía y GA (semanas/días)'); return; }
    const eco = new Date(ecoV);
    const gaDias = w*7 + d;
    const dpp = addDays(eco, 280 - gaDias);
    paint(dpp, addDays(dpp, -280));
  }

  function clearECO(){
    el.ecoDate.value = '';
    el.gaW.value = '';
    el.gaD.value = '';
    resetOut();
  }

  function copyRes(){
    if(!window.__res){ alert('Calcula primero 🙂'); return; }
    const r = window.__res;
    const txt = `DPP: ${r.dpp} · Ventana 38–42s: ${r.v38} – ${r.v42} · Gestación: ${r.semanas}s ${r.d}d`;
    navigator.clipboard.writeText(txt).then(() => alert('Resultado copiado ✅'));
  }

  function shareRes(){
    if(!window.__res){ alert('Calcula primero 🙂'); return; }
    const r = window.__res;
    const txt = `Mi DPP es ${r.dpp} (ventana ${r.v38}–${r.v42}). Calculado con la Calculadora FPP.`;
    if(navigator.share){ navigator.share({ title:'Mi DPP', text: txt, url: location.href }); }
    else{ alert('Compartir no disponible en este dispositivo. Copia el resultado.'); }
  }

  // Exposa les funcions perquè els botons onclick puguin cridar-les
  window.calcFUR = calcFUR;
  window.clearFUR = clearFUR;
  window.calcECO = calcECO;
  window.clearECO = clearECO;
  window.copyRes = copyRes;
  window.shareRes = shareRes;

  // Reset inicial
  resetOut();
});
</script>
